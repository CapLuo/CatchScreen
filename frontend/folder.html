<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>视频文件夹详情</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <style>
    .video-card { transition: transform .2s, box-shadow .2s; cursor: pointer; }
    .video-card:hover { transform: translateY(-3px); box-shadow: 0 .75rem 1.25rem rgba(0,0,0,.08); }
    .video-thumb { border-radius: 8px 8px 0 0; width: 100%; aspect-ratio: 16/9; object-fit: cover; background: #f2f2f2; }
    .skeleton { background: linear-gradient(90deg, #f2f2f2 25%, #e9ecef 37%, #f2f2f2 63%); background-size: 400% 100%; animation: shimmer 1.4s infinite; border-radius: 8px; height: 180px; }
    @keyframes shimmer { 0% { background-position: 100% 0; } 100% { background-position: -100% 0; } }
  </style>
</head>
<body class="bg-light">
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
    <div class="container">
      <a class="navbar-brand" href="index.html"><i class="bi bi-arrow-left"></i> 返回</a>
      <div class="navbar-text text-white" id="pageTitle">
        <i class="bi bi-folder"></i> <span id="folderName">-</span>
      </div>
      <div class="ms-auto">
        <button class="btn btn-outline-light btn-sm" onclick="loadVideos()"><i class="bi bi-arrow-clockwise"></i> 刷新</button>
      </div>
    </div>
  </nav>

  <div class="container py-4">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h5 class="mb-0"><i class="bi bi-camera-video-fill"></i> <span id="videoCount">0</span> 个视频</h5>
    </div>

    <div id="videosGrid" class="row g-3">
      <!-- 骨架屏占位 -->
      <div class="col-12 col-md-6 col-lg-4 col-xl-3"><div class="skeleton"></div></div>
      <div class="col-12 col-md-6 col-lg-4 col-xl-3"><div class="skeleton"></div></div>
      <div class="col-12 col-md-6 col-lg-4 col-xl-3"><div class="skeleton"></div></div>
      <div class="col-12 col-md-6 col-lg-4 col-xl-3"><div class="skeleton"></div></div>
    </div>
  </div>

  <!-- 视频播放模态框 -->
  <div class="modal fade" id="videoModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-xl">
      <div class="modal-content bg-dark">
        <div class="modal-header border-dark">
          <h5 class="modal-title text-white" id="videoTitle">播放视频</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-0">
          <video id="videoPlayer" controls autoplay style="width:100%;max-height:70vh;"></video>
        </div>
      </div>
    </div>
  </div>

  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1055;">
    <div id="toast" class="toast text-bg-danger" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="toastBody">错误</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const API_BASE = 'http://127.0.0.1:5000/api';
    let currentIP = '';
    const toast = new bootstrap.Toast(document.getElementById('toast'), { delay: 2500 });

    function showError(msg) { document.getElementById('toastBody').textContent = msg; toast.show(); }

    function getUrlParam(name) { const params = new URLSearchParams(window.location.search); return params.get(name); }

    async function checkAuth() {
      try {
        const response = await fetch(`${API_BASE}/check_login`, { credentials: 'include' });
        const result = await response.json();
        if (!result.logged_in) { window.location.href = 'login.html'; }
      } catch { window.location.href = 'login.html'; }
    }

    async function loadVideos() {
      currentIP = getUrlParam('ip');
      if (!currentIP) { showError('缺少文件夹参数'); window.location.href = 'index.html'; return; }
      document.getElementById('folderName').textContent = currentIP;

      try {
        const response = await fetch(`${API_BASE}/folders/${encodeURIComponent(currentIP)}`, { credentials: 'include' });
        if (response.status === 404) {
          document.getElementById('videosGrid').innerHTML = `<div class="col-12"><div class="alert alert-warning d-flex align-items-center"><i class=\"bi bi-exclamation-triangle me-2\"></i><div>文件夹不存在</div></div></div>`; return;
        }
        const result = await response.json();
        renderVideos(result.videos);
        document.getElementById('videoCount').textContent = result.videos.length;
      } catch (error) {
        document.getElementById('videosGrid').innerHTML = `<div class=\"col-12\"><div class=\"alert alert-danger d-flex align-items-center\"><i class=\"bi bi-exclamation-triangle me-2\"></i><div>加载失败：${error.message}</div></div></div>`;
        showError('加载失败');
      }
    }

    function renderVideos(videos) {
      const container = document.getElementById('videosGrid');
      if (!videos.length) {
        container.innerHTML = `<div class=\"col-12 text-center py-5\"><i class=\"bi bi-folder-x\" style=\"font-size: 4rem; color: #ccc;\"></i><p class=\"text-muted mt-3\">暂无视频</p></div>`; return;
      }
      container.innerHTML = videos.map(video => `
        <div class="col-12 col-md-6 col-lg-4 col-xl-3">
          <div class="video-card card shadow-sm" onclick="playVideo('${currentIP}', '${video}')">
            <img class="video-thumb" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='640' height='360'%3E%3Crect width='100%25' height='100%25' fill='%23f2f2f2'/%3E%3C/svg%3E" alt="thumb"/>
            <div class="card-body py-2">
              <div class="small text-truncate"><i class="bi bi-file-play"></i> ${video}</div>
            </div>
          </div>
        </div>`).join('');
    }

    function playVideo(ip, filename) {
      const modal = new bootstrap.Modal(document.getElementById('videoModal'));
      const player = document.getElementById('videoPlayer');
      const url = `http://127.0.0.1:5000/uploads/${ip}/${filename}`;
      player.src = url;
      document.getElementById('videoTitle').textContent = filename;
      modal.show();
      document.getElementById('videoModal').addEventListener('hidden.bs.modal', () => { player.pause(); player.src = ''; }, { once: true });
    }

    // 初始化
    checkAuth();
    loadVideos();
  </script>
</body>
</html>

